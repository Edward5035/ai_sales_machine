{% extends "base.html" %}

{% block page_title %}Lead Classifier{% endblock %}

{% block content %}
<!-- Classifier Header -->
<div class="modern-card p-4 mb-4">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h2 class="mb-1">
                <i class="fas fa-tags me-2 text-primary"></i>
                Lead Classification System
            </h2>
            <p class="mb-0">Organize and filter your leads by type, priority, and contact information</p>
        </div>
        <div class="col-lg-4 text-end">
            <button class="btn btn-outline-danger" onclick="clearAllLeads()" id="clearBtn">
                <i class="fas fa-trash me-1"></i>Clear All Leads
                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
            </button>
        </div>
    </div>
</div>

<!-- Classification Stats -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card sales-ready">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">{{ classified.sales_ready|length }}</h3>
                    <p class="mb-0">游릭 Sales-Ready Leads</p>
                    <small class="opacity-75">Phone + Website</small>
                </div>
                <div class="text-end">
                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card prospects">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">{{ classified.prospects|length }}</h3>
                    <p class="mb-0">游리 Prospect Leads</p>
                    <small class="opacity-75">Phone Only</small>
                </div>
                <div class="text-end">
                    <i class="fas fa-phone fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card total-leads">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">{{ classified.website_leads|length }}</h3>
                    <p class="mb-0">游댯 Website Leads</p>
                    <small class="opacity-75">Website Only</small>
                </div>
                <div class="text-end">
                    <i class="fas fa-globe fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card social-leads">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">{{ classified.social_leads|length }}</h3>
                    <p class="mb-0">游릮 Social Leads</p>
                    <small class="opacity-75">Social Media Profiles</small>
                </div>
                <div class="text-end">
                    <i class="fab fa-facebook fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="modern-card p-3 mb-4">
    <div class="row align-items-center">
        <div class="col-lg-6">
            <div class="d-flex align-items-center">
                <label class="form-label me-3 mb-0">Filter by Type:</label>
                <select class="form-select" id="typeFilter" onchange="filterLeads()">
                    <option value="all">All Leads</option>
                    <option value="Sales-Ready Lead">游릭 Sales-Ready Leads</option>
                    <option value="Prospect Lead">游리 Prospect Leads</option>
                    <option value="Website Lead">游댯 Website Leads</option>
                    <option value="social">游릮 Social Leads</option>
                </select>
            </div>
        </div>
        <div class="col-lg-6 text-end">
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="exportSelected()" id="exportBtn">
                    <i class="fas fa-download me-1"></i>Export Selected
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                </button>
                <button class="btn btn-outline-success" onclick="bulkOutreach()" id="bulkBtn">
                    <i class="fas fa-paper-plane me-1"></i>Bulk Outreach
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Leads Table -->
<div class="modern-card p-0" id="leadsTableContainer">
    <div class="table-responsive">
        <table id="classifierTable" class="table table-modern mb-0">
            <thead>
                <tr>
                    <th width="5%">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    <th>Business</th>
                    <th>Classification</th>
                    <th>Contact Score</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Website</th>
                    <th>Social Media</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="leadsTableBody">
                {% for lead in leads %}
                <tr data-lead-type="{{ lead.lead_type }}" data-has-social="{% if lead.facebook or lead.linkedin or lead.twitter or lead.instagram %}true{% else %}false{% endif %}">
                    <td>
                        <input type="checkbox" class="form-check-input lead-checkbox" data-lead-index="{{ loop.index0 }}">
                    </td>
                    <td>
                        <div>
                            <strong>{{ lead.name }}</strong>
                            {% if lead.address %}
                                <br><small class="text-muted">{{ lead.address[:50] }}{% if lead.address|length > 50 %}...{% endif %}</small>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if lead.lead_type == 'Sales-Ready Lead' %}
                            <span class="badge-sales-ready">游릭 Sales Ready</span>
                        {% elif lead.lead_type == 'Prospect Lead' %}
                            <span class="badge-prospect">游리 Prospect</span>
                        {% elif lead.lead_type == 'Website Lead' %}
                            <span class="badge-website-lead">游댯 Website Lead</span>
                        {% else %}
                            <span class="badge-social-lead">游릮 Social Lead</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="text-center">
                            <div class="progress mb-1" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ (lead.priority_score|default(0) / 8 * 100)|round }}%"></div>
                            </div>
                            <small class="text-muted">{{ lead.priority_score|default(0) }}/8</small>
                        </div>
                    </td>
                    <td>
                        {% if lead.phone %}
                            <a href="tel:{{ lead.phone }}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-phone me-1"></i>{{ lead.phone }}
                            </a>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if lead.email %}
                            <button class="btn btn-outline-primary btn-sm" onclick="composeEmail('{{ lead.email }}', '{{ lead.name }}')">
                                <i class="fas fa-envelope me-1"></i>{{ lead.email[:20] }}{% if lead.email|length > 20 %}...{% endif %}
                            </button>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if lead.website %}
                            <a href="{{ lead.website }}" target="_blank" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-globe me-1"></i>Visit
                            </a>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="social-icons">
                            {% if lead.facebook %}
                                <a href="{{ lead.facebook }}" target="_blank" class="facebook">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                            {% endif %}
                            {% if lead.linkedin %}
                                <a href="{{ lead.linkedin }}" target="_blank" class="linkedin">
                                    <i class="fab fa-linkedin-in"></i>
                                </a>
                            {% endif %}
                            {% if lead.twitter %}
                                <a href="{{ lead.twitter }}" target="_blank" class="twitter">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            {% endif %}
                            {% if lead.instagram %}
                                <a href="{{ lead.instagram }}" target="_blank" class="instagram">
                                    <i class="fab fa-instagram"></i>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/outreach-hub?lead={{ lead.name }}"><i class="fas fa-paper-plane me-2"></i>Add to Outreach</a></li>
                                <li><a class="dropdown-item" onclick="changePriority('{{ loop.index0 }}')"><i class="fas fa-star me-2"></i>Change Priority</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" onclick="deleteLead('{{ loop.index0 }}')"><i class="fas fa-trash me-2"></i>Delete Lead</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if not leads %}
<!-- Empty State -->
<div class="modern-card p-5 text-center">
    <div class="mb-4">
        <i class="fas fa-tags fa-4x text-muted"></i>
    </div>
    <h4 class="text-muted mb-3">No Leads to Classify</h4>
    <p class="text-muted mb-4">Search for leads first to start using the classification system.</p>
    <a href="/lead-finder" class="btn btn-gradient-primary btn-lg">
        <i class="fas fa-search me-2"></i>Find Leads
    </a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Initialize DataTable
$(document).ready(function() {
    $('#classifierTable').DataTable({
        pageLength: 50,
        order: [[3, 'desc']], // Sort by contact score
        destroy: true, // Allow reinitializing the table
        columnDefs: [
            { orderable: false, targets: [0, 8] } // Disable sorting for checkbox and actions
        ],
        language: {
            search: "Search leads:",
            lengthMenu: "Show _MENU_ leads per page",
            info: "Showing _START_ to _END_ of _TOTAL_ leads"
        }
    });
});

// Filter leads by type
function filterLeads() {
    const filterValue = document.getElementById('typeFilter').value;
    const rows = document.querySelectorAll('#leadsTableBody tr');
    
    rows.forEach(row => {
        if (filterValue === 'all') {
            row.style.display = '';
        } else if (filterValue === 'social') {
            row.style.display = row.dataset.hasSocial === 'true' ? '' : 'none';
        } else {
            row.style.display = row.dataset.leadType === filterValue ? '' : 'none';
        }
    });
}

// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.lead-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Export selected leads
function exportSelected() {
    const btn = document.getElementById('exportBtn');
    const spinner = btn.querySelector('.spinner-border');
    const originalText = btn.innerHTML;
    
    const selectedLeads = [];
    const checkboxes = document.querySelectorAll('.lead-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Please select leads to export');
        return;
    }
    
    // Show spinner
    btn.disabled = true;
    spinner.classList.remove('d-none');
    btn.innerHTML = '<i class="fas fa-download me-1"></i>Exporting... <span class="spinner-border spinner-border-sm ms-2" role="status"></span>';
    
    // Create export form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/export_csv';
    form.style.display = 'none';
    
    const input = document.createElement('input');
    input.name = 'data';
    input.value = JSON.stringify(Array.from(checkboxes).map(cb => leads[cb.dataset.leadIndex]));
    
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    // Reset button after a delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
}

// Bulk outreach
function bulkOutreach() {
    const btn = document.getElementById('bulkBtn');
    const spinner = btn.querySelector('.spinner-border');
    const originalText = btn.innerHTML;
    
    const selectedLeads = document.querySelectorAll('.lead-checkbox:checked');
    
    if (selectedLeads.length === 0) {
        alert('Please select leads for outreach');
        return;
    }
    
    // Show spinner
    btn.disabled = true;
    spinner.classList.remove('d-none');
    btn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Processing... <span class="spinner-border spinner-border-sm ms-2" role="status"></span>';
    
    const leadNames = Array.from(selectedLeads).map(cb => 
        cb.closest('tr').querySelector('strong').textContent
    );
    
    // Redirect to outreach hub with selected leads
    window.location.href = `/outreach-hub?selected=${encodeURIComponent(leadNames.join(','))}`;
}

// Change priority
function changePriority(index) {
    const newPriority = prompt('Enter new priority (1-8):');
    if (newPriority && newPriority >= 1 && newPriority <= 8) {
        // You can implement priority update here
        alert(`Priority updated to ${newPriority}`);
    }
}

// Delete lead
function deleteLead(index) {
    if (confirm('Are you sure you want to delete this lead?')) {
        // You can implement lead deletion here
        alert('Lead deleted');
    }
}

// Clear all leads
function clearAllLeads() {
    const btn = document.getElementById('clearBtn');
    const spinner = btn.querySelector('.spinner-border');
    const originalText = btn.innerHTML;
    
    if (confirm('Are you sure you want to clear all leads? This cannot be undone.')) {
        // Show spinner
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btn.innerHTML = '<i class="fas fa-trash me-1"></i>Clearing... <span class="spinner-border spinner-border-sm ms-2" role="status"></span>';
        
        fetch('/clear-leads', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => {
                alert('Error clearing leads');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }
}

// Compose email function
function composeEmail(email, businessName) {
    const subject = encodeURIComponent(`Partnership Opportunity - ${businessName}`);
    const body = encodeURIComponent(`Hi there,\n\nI came across ${businessName} and would love to discuss a potential partnership opportunity.\n\nBest regards,\n[Your Name]`);
    
    window.open(`mailto:${email}?subject=${subject}&body=${body}`);
}

// Store leads data for JavaScript access
const leads = {{ leads | tojson | safe }};
</script>
{% endblock %}